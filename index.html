<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme-color" content="#4f46e5">

  <title>Offerte.app - Il Motore di Ricerca del Risparmio</title>
  <meta name="description" content="Confronta prezzi in tempo reale su Amazon, eBay e centinaia di negozi online. Trova sempre il miglior prezzo con Offerte.app.">
  <meta name="robots" content="index, follow">

  <!-- Tailwind CSS (CDN per prototipo) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    .font-mono { font-family: 'JetBrains Mono', monospace; }

    /* Hide scrollbar */
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
    .deal-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .deal-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }

    /* Terminal */
    .system-terminal {
      transition: max-height 0.4s ease-in-out, opacity 0.3s ease;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
    }
    .system-terminal.active {
      max-height: 200px;
      opacity: 1;
    }

    /* Scan overlay */
    .scan-overlay {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(to bottom, transparent, rgba(79, 70, 229, 0.12), transparent);
      transform: translateY(-100%);
      animation: scan-vertical 2s linear infinite;
      pointer-events: none;
      display: none;
    }
    .group:hover .scan-overlay { display: block; }
    @keyframes scan-vertical {
      0% { transform: translateY(-100%); }
      100% { transform: translateY(100%); }
    }
    body.is-scanning .scan-overlay { display: block; }

    .bottom-nav-padding { padding-bottom: 80px; }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen selection:bg-indigo-100 selection:text-indigo-800">

  <!-- Top App Bar -->
  <header class="fixed w-full z-40 bg-white/95 backdrop-blur-md shadow-sm border-b border-gray-100 top-0 transition-all duration-300">
    <div class="container mx-auto px-4 lg:px-8 h-16 flex items-center justify-between gap-4">
      <!-- Logo -->
      <a href="#" class="flex-shrink-0 flex items-center group" onclick="resetFilters(); return false;">
        <div class="bg-gradient-to-br from-indigo-600 to-blue-600 text-white p-2 rounded-xl mr-2 shadow-lg group-hover:rotate-6 transition-transform duration-300">
          <i class="fas fa-search-dollar text-lg"></i>
        </div>
        <div class="flex flex-col">
          <span class="text-xl font-black text-gray-900 tracking-tight leading-none">Offerte<span class="text-indigo-600">.app</span></span>
          <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest hidden sm:block">Motore di Ricerca</span>
        </div>
      </a>

      <!-- Search -->
      <div class="flex-1 max-w-2xl relative group">
        <div class="relative transition-transform duration-300 focus-within:scale-[1.01]">
          <label for="searchInput" class="sr-only">Cerca offerte</label>
          <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
            <i class="fas fa-search text-gray-400 group-focus-within:text-indigo-500 transition-colors"></i>
          </div>
          <input
            type="text"
            id="searchInput"
            placeholder="Cerca il miglior prezzo (es. iPhone 15, PS5...)"
            class="w-full bg-gray-100/80 hover:bg-white text-gray-900 border-2 border-transparent focus:border-indigo-500 rounded-2xl py-2.5 pl-11 pr-10 focus:ring-4 focus:ring-indigo-100 focus:bg-white transition-all shadow-inner text-sm sm:text-base font-medium placeholder-gray-400"
            autocomplete="off"
          >

          <div id="searchIndicator" class="absolute inset-y-0 right-0 pr-3 flex items-center hidden">
            <i class="fas fa-circle-notch fa-spin text-indigo-500"></i>
          </div>
          <div
            id="searchClear"
            class="absolute inset-y-0 right-0 pr-3 flex items-center hidden cursor-pointer text-gray-400 hover:text-red-500 transition-colors transform hover:rotate-90 duration-200"
            onclick="resetFilters()"
            role="button"
            aria-label="Pulisci ricerca"
            tabindex="0"
          >
            <i class="fas fa-times-circle text-lg"></i>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3 sm:gap-4 flex-shrink-0">
        <!-- PWA Install (Web App) -->
        <button id="installBtn" class="hidden sm:flex items-center gap-2 bg-white text-gray-700 hover:text-indigo-600 px-4 py-2 rounded-xl font-bold text-sm transition shadow-sm border border-gray-200 hover:border-indigo-300" type="button">
          <i class="fas fa-plus-square"></i>
          <span>Aggiungi alla Home</span>
        </button>
      </div>
    </div>

    <!-- Terminal -->
    <div id="systemTerminal" class="system-terminal bg-gray-900 text-green-400 font-mono text-xs sm:text-sm border-t border-b border-gray-800 shadow-inner">
      <div class="container mx-auto px-4 py-3">
        <div class="flex items-center gap-2 mb-2 text-gray-500 border-b border-gray-800 pb-1">
          <i class="fas fa-server"></i> PRICE_SCANNER_V4.exe
          <span class="ml-auto text-[10px] bg-indigo-900 text-indigo-200 px-2 rounded">NETWORK ACTIVE</span>
        </div>
        <div id="systemLogs" class="space-y-1 h-24 overflow-y-auto" aria-live="polite"></div>
      </div>
    </div>

    <!-- Mobile Categories -->
    <div class="lg:hidden border-t border-gray-100 bg-white/95 backdrop-blur">
      <div class="flex overflow-x-auto gap-2 px-4 py-3 scrollbar-hide" id="mobileCategories"></div>
    </div>
  </header>

  <!-- Main Layout -->
  <div class="flex flex-1 pt-[120px] lg:pt-[90px] bottom-nav-padding container mx-auto px-4 lg:px-8 gap-8">

    <!-- Sidebar Filters -->
    <aside class="hidden lg:block w-64 flex-shrink-0 fixed h-[calc(100vh-90px)] overflow-y-auto pb-10 pr-4 scrollbar-hide">
      <div class="space-y-8">
        <div>
          <h3 class="font-bold text-gray-900 mb-4 px-2 flex items-center gap-2">
            <i class="fas fa-layer-group text-indigo-500"></i> Categorie
          </h3>
          <nav class="space-y-1" id="desktopCategories"></nav>
        </div>

        <div class="bg-white rounded-2xl p-5 text-gray-800 shadow-lg border border-gray-100 relative overflow-hidden group">
          <div class="flex items-center gap-2 mb-3">
            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
            <span class="text-xs font-bold text-gray-500 uppercase">Stato Scanner</span>
          </div>
          <p class="font-bold text-lg mb-1">Online</p>
          <p class="text-xs text-gray-500 mb-4">Monitoraggio attivo su store e sorgenti pubbliche. Aggiornamento continuo.</p>

          <div class="w-full bg-gray-100 rounded-full h-1.5 mb-2 overflow-hidden">
            <div class="bg-indigo-500 h-1.5 rounded-full" style="width: 100%"></div>
          </div>
          <div class="flex justify-between text-[10px] text-gray-400 font-mono">
            <span>AMZ: OK</span>
            <span>EBY: OK</span>
            <span>UNI: OK</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 lg:ml-72 min-w-0 pb-12">

      <div class="flex items-end justify-between mb-8">
        <div>
          <h1 class="text-2xl lg:text-3xl font-black text-gray-900 tracking-tight flex items-center gap-2" id="pageTitle">
            Feed Offerte <span class="hidden sm:inline-block w-2 h-2 bg-red-500 rounded-full"></span>
          </h1>
          <p class="text-gray-500 text-sm mt-1">Confrontiamo offerte disponibili su store e canali pubblici per farti risparmiare.</p>
        </div>
        <div class="hidden sm:flex items-center gap-2 text-sm">
          <span class="text-gray-400 text-xs">Ordina per:</span>
          <select id="sortSelect" class="bg-white border-none text-gray-900 font-bold focus:ring-0 cursor-pointer" aria-label="Ordina risultati">
            <option value="relevance">Rilevanza</option>
            <option value="price">Prezzo più basso</option>
            <option value="discount">Sconto maggiore %</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6" id="dealsGrid"></div>

      <div id="noResults" class="hidden text-center py-20 animate-fade-in-up">
        <div class="inline-flex items-center justify-center w-24 h-24 bg-gray-100 rounded-full mb-6 relative">
          <i class="fas fa-search text-4xl text-gray-300"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">Nessun risultato trovato</h3>
        <p class="text-gray-500 max-w-md mx-auto mb-6">Non abbiamo trovato offerte coerenti per questa ricerca.</p>
        <button onclick="resetFilters()" class="bg-indigo-600 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-indigo-700 transition" type="button">Torna alla Home</button>
      </div>

      <div id="sourcesBox" class="hidden mt-10 bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
        <div class="flex items-center justify-between gap-4 mb-3">
          <h2 class="font-extrabold text-gray-900 flex items-center gap-2">
            <i class="fas fa-link text-indigo-600"></i> Sorgenti consultate
          </h2>
          <span class="text-[11px] text-gray-500 font-mono">Link utili per verificare prezzi e disponibilità.</span>
        </div>
        <ul id="sourcesList" class="space-y-2 text-sm"></ul>
      </div>

    </main>
  </div>

  <!-- Mobile Bottom Navigation -->
  <div class="lg:hidden fixed bottom-0 w-full bg-white/95 backdrop-blur-lg border-t border-gray-200 z-50 pb-safe shadow-[0_-5px_10px_rgba(0,0,0,0.02)]">
    <div class="flex justify-around items-center h-16 px-2">
      <a href="#" class="flex flex-col items-center justify-center w-full h-full text-indigo-600" onclick="resetFilters(); return false;">
        <i class="fas fa-home text-xl mb-0.5"></i>
        <span class="text-[10px] font-bold">Home</span>
      </a>
      <div class="relative -top-6">
        <button class="w-14 h-14 bg-indigo-600 rounded-2xl text-white shadow-xl flex items-center justify-center text-xl hover:shadow-indigo-500/40 transition transform active:scale-95 group border border-indigo-500" onclick="document.getElementById('searchInput').focus()" type="button">
          <i class="fas fa-search group-hover:scale-110 transition-transform"></i>
        </button>
      </div>
      <a href="#" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-indigo-500">
        <i class="far fa-heart text-xl mb-0.5"></i>
        <span class="text-[10px] font-medium">Salvati</span>
      </a>
    </div>
  </div>

  <script>
    // --- DATA ---
    const categories = [
      { id: 'all', name: 'Tutte', icon: 'fas fa-th-large' },
      { id: 'tech', name: 'Tech', icon: 'fas fa-mobile-alt' },
      { id: 'home', name: 'Casa', icon: 'fas fa-couch' },
      { id: 'fashion', name: 'Moda', icon: 'fas fa-tshirt' },
      { id: 'gaming', name: 'Gaming', icon: 'fas fa-gamepad' },
      { id: 'coupons', name: 'Coupon', icon: 'fas fa-ticket-alt' }
    ];

    // Nota: i dati demo vengono sostituiti automaticamente dalla Home live (API)
    const staticDeals = [
      { id: 1, title: 'Apple AirPods Pro (2ª gen) USB-C', price: 239.00, originalPrice: 279.00, discount: 15, store: 'Amazon', image: 'https://images.unsplash.com/photo-1603351154351-5cf99703f6a8?auto=format&fit=crop&w=500&q=80', category: 'tech', hot: true, time: 'Demo', url: '#' },
      { id: 2, title: 'PlayStation 5 Slim Standard', price: 449.99, originalPrice: 549.99, discount: 18, store: 'MediaWorld', image: 'https://images.unsplash.com/photo-1606813907291-d86efa9b94db?auto=format&fit=crop&w=500&q=80', category: 'gaming', hot: true, time: 'Demo', url: '#' },
      { id: 4, title: 'Codice Sconto Nike Ufficiale', price: 0, originalPrice: 0, discount: 25, store: 'Nike', image: 'https://images.unsplash.com/photo-1542291026-7eec264c27ff?auto=format&fit=crop&w=500&q=80', category: 'coupons', code: 'NIKE25', hot: true, time: 'Demo', url: '#' },
      { id: 7, title: 'MacBook Air M2 13" Galassia', price: 999.00, originalPrice: 1349.00, discount: 26, store: 'Amazon', image: 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=500&q=80', category: 'tech', hot: true, time: 'Demo', url: '#' }
    ];

    let currentCategory = 'all';
    let lastResults = [...staticDeals];

    const $ = (id) => document.getElementById(id);

    function defaultTitleHTML() {
      return 'Feed Offerte <span class="hidden sm:inline-block w-2 h-2 bg-red-500 rounded-full"></span>';
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function setScanningUI(isOn) {
      const terminal = $('systemTerminal');
      const logs = $('systemLogs');
      const searchIndicator = $('searchIndicator');
      const searchClear = $('searchClear');

      if (isOn) {
        document.body.classList.add('is-scanning');
        terminal.classList.add('active');
        logs.innerHTML = '';
        searchIndicator.classList.remove('hidden');
        searchClear.classList.add('hidden');
      } else {
        terminal.classList.remove('active');
        searchIndicator.classList.add('hidden');
        searchClear.classList.remove('hidden');
        document.body.classList.remove('is-scanning');
      }
    }

    function addLog(message, type = 'info') {
      const logs = $('systemLogs');
      const line = document.createElement('div');
      const timestamp = new Date().toLocaleTimeString('it-IT', { hour12: false });

      let colorClass = 'text-gray-300';
      if (type === 'success') colorClass = 'text-green-400';
      if (type === 'warn') colorClass = 'text-yellow-400';
      if (type === 'process') colorClass = 'text-blue-400';

      line.className = `font-mono text-xs ${colorClass}`;
      line.innerHTML = `<span class="opacity-50">[${timestamp}]</span> ${message}`;

      logs.appendChild(line);
      logs.scrollTop = logs.scrollHeight;
    }

    function sortDeals(deals, mode) {
      const d = [...deals];
      if (mode === 'price') d.sort((a,b) => (a.price ?? Infinity) - (b.price ?? Infinity));
      if (mode === 'discount') d.sort((a,b) => (b.discount ?? -Infinity) - (a.discount ?? -Infinity));
      return d;
    }

    function renderCategories() {
      const desktopNav = $('desktopCategories');
      const mobileNav = $('mobileCategories');
      desktopNav.innerHTML = '';
      mobileNav.innerHTML = '';

      categories.forEach((cat) => {
        const isActive = cat.id === currentCategory;
        const activeClass = isActive
          ? 'bg-indigo-50 text-indigo-700 font-bold border-l-4 border-indigo-600'
          : 'text-gray-600 hover:bg-gray-50 hover:text-indigo-600';

        desktopNav.innerHTML += `
          <button onclick="filterCategory('${cat.id}')" class="w-full text-left flex items-center gap-3 px-4 py-3 transition-all duration-200 ${activeClass}" aria-pressed="${isActive}" type="button">
            <div class="w-6 text-center"><i class="${cat.icon}"></i></div>
            <span class="text-sm">${cat.name}</span>
          </button>
        `;

        mobileNav.innerHTML += `
          <button onclick="filterCategory('${cat.id}')" class="flex-shrink-0 px-5 py-2 rounded-full text-sm font-bold border transition-all duration-200 active:scale-95 ${isActive ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white text-gray-600 border-gray-200'}" aria-pressed="${isActive}" type="button">
            ${cat.name}
          </button>
        `;
      });
    }

    function renderSources(sources) {
      const box = $('sourcesBox');
      const list = $('sourcesList');
      list.innerHTML = '';
      if (!sources || !sources.length) {
        box.classList.add('hidden');
        return;
      }
      sources.slice(0, 10).forEach(s => {
        const title = escapeHtml(s.title || 'Fonte');
        const uri = escapeHtml(s.uri || '#');
        list.innerHTML += `
          <li class="flex items-start gap-2">
            <i class="fas fa-external-link-alt text-indigo-600 mt-1"></i>
            <a class="text-gray-800 hover:text-indigo-700 font-semibold underline underline-offset-2" href="${uri}" target="_blank" rel="noopener">${title}</a>
          </li>
        `;
      });
      box.classList.remove('hidden');
    }

    function renderDeals(dealsToRender) {
      const grid = $('dealsGrid');
      const noResults = $('noResults');

      grid.innerHTML = '';

      if (!dealsToRender || dealsToRender.length === 0) {
        noResults.classList.remove('hidden');
        return;
      }
      noResults.classList.add('hidden');

      const sortMode = $('sortSelect')?.value || 'relevance';
      const dealsSorted = sortDeals(dealsToRender, sortMode);

      dealsSorted.forEach((deal, index) => {
        const isCoupon = (deal.category === 'coupons') || (!!deal.code && (deal.price === 0 || deal.price === null));
        const delay = index * 60;

        const img = deal.image || 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?auto=format&fit=crop&w=500&q=80';
        const store = deal.store || 'Store';
        const time = deal.time || 'Adesso';
        const url = deal.url || '#';

        grid.innerHTML += `
          <article class="deal-card bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden group flex flex-col h-full animate-fade-in-up" style="animation-delay:${delay}ms">
            <div class="relative h-48 overflow-hidden bg-gray-100">
              <img src="${escapeHtml(img)}" alt="${escapeHtml(deal.title || 'Offerta')}" class="w-full h-full object-cover group-hover:scale-110 transition duration-700 ease-in-out" loading="lazy" decoding="async">
              <div class="scan-overlay"></div>
              ${deal.hot ? '<span class="absolute top-2 right-2 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded shadow animate-pulse">HOT</span>' : ''}
              <span class="absolute bottom-2 right-2 bg-white/90 backdrop-blur text-indigo-900 text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1 shadow-sm">
                <i class="fas fa-store"></i> ${escapeHtml(store)}
              </span>
            </div>

            <div class="p-5 flex flex-col flex-1 relative">
              <div class="flex justify-between items-start mb-2">
                <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider flex items-center gap-1">
                  <i class="fas fa-clock"></i> ${escapeHtml(time)}
                </span>
              </div>

              <h3 class="font-bold text-gray-800 mb-2 leading-snug line-clamp-2 group-hover:text-indigo-600 transition-colors">
                ${escapeHtml(deal.title || 'Offerta')}
              </h3>

              ${!isCoupon ? `
                <div class="mt-auto pt-3 border-t border-gray-50 flex justify-between items-end">
                  <div>
                    <div class="flex items-center gap-2">
                      ${(deal.originalPrice != null) ? `<span class="text-gray-400 line-through text-xs">€${Number(deal.originalPrice).toFixed(2)}</span>` : ''}
                      ${(deal.discount != null) ? `<span class="bg-indigo-50 text-indigo-700 text-[10px] font-bold px-1.5 py-0.5 rounded">-${Number(deal.discount)}%</span>` : ''}
                    </div>
                    <div class="text-gray-900 font-black text-xl tracking-tight">
                      ${(deal.price != null) ? `€${Number(deal.price).toFixed(2)}` : 'Prezzo N/D'}
                    </div>
                  </div>

                  <a href="${escapeHtml(url)}" target="_blank" rel="noopener" class="bg-gray-900 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-indigo-600 transition shadow-lg hover:shadow-indigo-200 transform active:scale-90" aria-label="Apri offerta">
                    <i class="fas fa-arrow-right"></i>
                  </a>
                </div>
              ` : `
                <div class="mt-auto pt-3">
                  <button onclick="copyCoupon('${String(deal.code || '').replace(/'/g, "\\'")}', this)" class="w-full bg-indigo-50 border border-indigo-200 border-dashed text-indigo-700 font-mono py-2 rounded-lg text-sm hover:bg-indigo-100 transition flex justify-center items-center gap-2" aria-label="Copia coupon" type="button">
                    ${escapeHtml(deal.code || 'COPIA CODICE')} <i class="far fa-copy"></i>
                  </button>
                </div>
              `}
            </div>
          </article>
        `;
      });
    }

    // --- API CALLS ---
    async function liveSearch(query) {
      setScanningUI(true);
      addLog(`Avvio scansione prezzi per: "${query}"...`, 'process');
      addLog('Connessione ai canali monitorati...', 'info');

      try {
        const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
        const data = await res.json();

        if (!res.ok) {
          addLog(`Errore servizio (${res.status}): ${data?.error || 'unknown'}`, 'warn');
          return { deals: [], sources: [] };
        }

        addLog('Dati ricevuti. Normalizzazione e ranking...', 'process');
        addLog(`Risultati: ${Array.isArray(data.deals) ? data.deals.length : 0}`, 'success');

        return {
          deals: Array.isArray(data.deals) ? data.deals : [],
          sources: Array.isArray(data.sources) ? data.sources : []
        };
      } catch (e) {
        addLog(`Errore di rete: ${e?.message || e}`, 'warn');
        return { deals: [], sources: [] };
      } finally {
        setScanningUI(false);
      }
    }

    async function loadHome() {
      setScanningUI(true);
      addLog('Caricamento Home: migliori offerte per categoria...', 'process');
      try {
        const res = await fetch('/api/home');
        const data = await res.json();

        if (!res.ok) {
          addLog(`Home non disponibile (${res.status}). Uso feed demo.`, 'warn');
          return;
        }

        if (Array.isArray(data.deals) && data.deals.length) {
          lastResults = data.deals;
          currentCategory = 'all';
          renderCategories();
          renderDeals(data.deals);
          renderSources(Array.isArray(data.sources) ? data.sources : []);
          addLog(`Home aggiornata (${data.deals.length} offerte).`, 'success');
        } else {
          addLog('Home: nessuna offerta disponibile.', 'warn');
        }
      } catch (e) {
        addLog(`Home: errore rete (${e?.message || e}).`, 'warn');
      } finally {
        setScanningUI(false);
      }
    }

    // --- EVENTS / UI ---
    const searchInput = $('searchInput');
    const pageTitle = $('pageTitle');

    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const term = (e.target.value || '').trim();
        if (term.length > 1) {
          liveSearch(term).then(({deals, sources}) => {
            lastResults = deals;
            currentCategory = 'all';
            renderCategories();
            renderDeals(deals);
            renderSources(sources);
            pageTitle.innerHTML = `Risultati per: <span class="text-indigo-600">"${escapeHtml(term)}"</span>`;
          });
        }
      }
    });

    $('searchClear')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') resetFilters();
    });

    $('sortSelect')?.addEventListener('change', () => renderDeals(lastResults));

    window.resetFilters = function() {
      searchInput.value = '';
      $('systemTerminal').classList.remove('active');
      document.body.classList.remove('is-scanning');

      $('searchIndicator')?.classList.add('hidden');
      $('searchClear')?.classList.add('hidden');

      currentCategory = 'all';
      lastResults = [...staticDeals];
      renderCategories();
      renderDeals(staticDeals);
      renderSources([]);

      pageTitle.innerHTML = defaultTitleHTML();
      $('noResults')?.classList.add('hidden');
    }

    window.filterCategory = function(catId) {
      currentCategory = catId;

      const filtered = catId === 'all'
        ? staticDeals
        : staticDeals.filter(deal => deal.category === catId);

      lastResults = filtered;
      renderCategories();
      renderDeals(filtered);
      renderSources([]);

      const cat = categories.find(c => c.id === catId);
      const catName = cat ? cat.name : 'Tutte';
      pageTitle.innerHTML = catId === 'all' ? defaultTitleHTML() : escapeHtml(catName);
    };

    window.copyCoupon = function(code, btn) {
      const successUI = () => {
        const originalHtml = btn.innerHTML;
        const originalClass = btn.className;
        btn.innerHTML = `<i class="fas fa-check"></i> COPIATO`;
        btn.className = 'w-full bg-green-500 text-white font-bold py-2 rounded-lg text-sm transition shadow-lg';
        setTimeout(() => { btn.innerHTML = originalHtml; btn.className = originalClass; }, 2000);
      };

      const fallbackCopy = () => {
        const ta = document.createElement('textarea');
        ta.value = code;
        ta.setAttribute('readonly', '');
        ta.style.position = 'absolute';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); successUI(); }
        catch (e) { console.warn('Copy failed', e); }
        finally { document.body.removeChild(ta); }
      };

      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(code).then(successUI).catch(fallbackCopy);
      } else {
        fallbackCopy();
      }
    }

    // --- PWA INSTALL (Web App) ---
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const btn = $('installBtn');
      if (btn) btn.classList.remove('hidden');
    });

    $('installBtn')?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      $('installBtn')?.classList.add('hidden');
    });

    // --- INIT ---
    renderCategories();
    renderDeals(staticDeals);
    loadHome();

    // --- BASIC RUNTIME CHECKS (dev-only console) ---
    // Serve solo a evitare regressioni: non impatta UI.
    (function runtimeChecks(){
      try {
        if (typeof liveSearch !== 'function') throw new Error('liveSearch missing');
        if (typeof loadHome !== 'function') throw new Error('loadHome missing');
        if (!Array.isArray(categories) || categories.length < 2) throw new Error('categories invalid');
        if (!Array.isArray(staticDeals) || staticDeals.length < 1) throw new Error('staticDeals invalid');
      } catch (err) {
        console.error('[Offerte.app] Runtime checks failed:', err);
      }
    })();
  </script>
</body>
</html>
